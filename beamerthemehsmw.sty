\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{beamerthemehsmw}[2022/05/02 Beamer Vorlage der Hochschule Mittweida (Schildbach Stefan)] % https://zip.hs-mittweida.de/intranet/corporate_design.php
% Please note: This template currently addresses only pdflatex (no active support for lualatex or xelatex)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Process theme options

% Allows options as key-value pairs - Need to use \DeclareOptionX, \ProcessOptionsX ect.
\RequirePackage{xkeyval} 

\makeatletter
	% Sets the default faculty to hs (responsible for color model, default institute and default logo)
	\def\default@faculty{} 							
	\DeclareOptionX{hs}{\def\default@faculty{}}			% <empty>, hs, ext, inst
	\DeclareOptionX{inw}{\def\default@faculty{inw}}		% inw, mb
	\DeclareOptionX{cb}{\def\default@faculty{cb}}		% cb, mni
	\DeclareOptionX{wi}{\def\default@faculty{wi}}		% wi, ww
	\DeclareOptionX{sw}{\def\default@faculty{sw}}		% sw, sa
	\DeclareOptionX{me}{\def\default@faculty{me}}		% me
	\DeclareOptionX{faculty}[]{\def\default@faculty{#1}}

	% Insert a separate frame for each section heading (ignore \section*) (default: off)
	\DeclareOptionX{sectionslide}{\AtBeginSection[]{\begin{frame}<beamer>[plain]\sectionpage\end{frame}}}

	% Insert a table of contents at the beginning of the document (default: off)
	\DeclareOptionX{toc}{\AddToHook{begindocument/end}{\maketoc}}

	% Declare language as key value Option with default ngerman. Passes language directly to babel 
	\DeclareOptionX{language}[ngerman]{\PassOptionsToPackage{#1}{babel}}

	% Shows the progressbar in footline (default: on)
	\newtoggle{show@progressbar}  % \settoggle{show@progressbar}{true|false} \toggletrue{show@progressbar} % \iftoggle{show@progressbar}{if}{else}
	\DeclareOptionX{progressbar}{\toggletrue{show@progressbar}}

	% Hides the total number of slide in footline (default: on)
	\newtoggle{show@totalpages}\toggletrue{show@totalpages}
	\DeclareOptionX{nototalpages}{\togglefalse{show@totalpages}}

	% Hides the faculty icon on title page (default: on)
	\newtoggle{show@facultyicon}\toggletrue{show@facultyicon}
	\DeclareOptionX{nofacultyicon}{\togglefalse{show@facultyicon}}

	% Enables some fancy styles, that are not part of the corporate design specifications (default: off)
	\newtoggle{use@fancystyle}
	\DeclareOptionX{fancystyle}{\toggletrue{use@fancystyle}}
	
	% Shows the date on the titelpage
	\newtoggle{show@titlepagedate}
	\DeclareOptionX{titlepagedate}{\toggletrue{show@titlepagedate}}

	% Enables coloring of math text
	\newtoggle{use@colormath}
	\DeclareOptionX{colormath}{\toggletrue{use@colormath}}

	\ExecuteOptionsX{language=ngerman}% Default options to be loaded 
	\ProcessOptionsX\relax
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Load Packages
% Preloaded packages by beamer in presentation mode: amsthm, color, enumerate, hyperref, xcolor

\RequirePackage{iftex}
\ifxetex%
    \PassOptionsToPackage{defaultsans}{opensans}%make opensans default sans font
\else%
    \ifluatex%
        \PassOptionsToPackage{defaultsans}{opensans}%make opensans default sans font
    \else%
        \RequirePackage[T1]{fontenc} % Font-Encoding
        \RequirePackage[utf8]{inputenc} % Input-Encoding
    \fi
\fi
\RequirePackage{lmodern} % Font tweaking to latin modern (less pixelated) as fallback font

\RequirePackage[default,proportional,scale=0.95]{opensans} % Use OpenSans as default font, slightly downscaled - Numbers: oldstyle | lining (default) and tabular (default) | proportional

\RequirePackage{babel}% load babel package - Options comes from package Option 'language' 

\RequirePackage[fixed]{fontawesome5} % Symbols (marvosym)
%TODO: loading csquotes package and its options may depend on the choosen language
\RequirePackage[autostyle=true,german=quotes]{csquotes} % Improves nested quoting in bibliography (provides \enquote makro for quoting)
%\RequirePackage[factor=1100, stretch=10, shrink=10, babel=true, nopatch=footnote]{microtype} %TODO: Seems to have problems within overleaf: "keyval error: nopatch undefined"

\RequirePackage{etoolbox} % Programming library
\RequirePackage{tikz} % Tikz-Library for improved drawing capabilities
\RequirePackage{tikz-layers} % Loads background library and creates new layers to use as scope options "backround", "behind", "main" (normal), "above", "glass" -> e.g. "on above layer"

\RequirePackage[absolute, overlay]{textpos} % Abosolute placement of elements (display with option showboxes)
\RequirePackage{tabularx, booktabs} % Tabular packages
\RequirePackage{adjustbox} % Versatile boy environments (e.g. resizebox)
\RequirePackage{caption}

\RequirePackage[
%	backend=biber,	% Specified used backend (biber, bibtex, bibtex8); default:biber
	style=ieee,		% Used bibliography and citation style (bbx and cbx) % use bibstyle=<> and citestyle=<> for separate use; default: numeric
	citestyle=numeric-comp, % multiple citation numbers all within same bracket \cite{keya, keyb}
	sorting=none,	% Sorting order of bibliography (default: nty = name title year); none: no sorting, entries are processed in citation order
	%
	natbib=true,	% Compatiobility mode for natbib cite-aliases; default: false
	hyperref=true,	% Convert citations and back references to hyperlinks; default: auto (like true, but without warning if package not loaded)
	backref=false,	% Print backreferences; default: false
	% Style specific
	dashed=false	% Recurring authors and names are replaced by a dash (references with modified ugly "default dashes" if one author occurs multiple times in a row in the bibliography)
]{biblatex} % Bibliography

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Default configurations

% Sets the page grid to the default aspect ratio for easy alignment: (1, 1) is 1 cm away from the right and top border; (8, 4.5) is the page center
\TPGrid{16}{9} 

% Sets the distance between figure/table and caption
\captionsetup{skip=.25cm}

% Adds the subtitle into the pdf document metadata
\AddToHook{begindocument/before}{\subject{\insertsubtitle}}
% Leaves pdf metadata keywords empty
\keywords{}

% TODO If more than one institute is given, they should be separated using the command \and and they should be prefixed by the command \inst with different parameters.
%\institute[]{} 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Latex switch case construct

\newboolean{default}
\newcommand{\case}{}
\newcommand{\default}{}
\newenvironment{switch}[1]%
{%
	\setboolean{default}{true}%
	\renewcommand{\case}[2]{\ifthenelse{\equal{#1}{##1}}{\setboolean{default}{false}##2}{}}%
	\renewcommand{\default}[1]{\ifthenelse{\boolean{default}}{##1}{}}%
}{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Set faculty name and icon

% The name of the faculty (default: empty)
\newcommand{\insertfacultyname}{} 
% The faculty logo (default: all icons side by side)
\newcommand{\insertfacultyicon}
{%
	\foreach \f in {INW, CB, WI, SW, ME, HS}%
	{%
		\includegraphics[height=0.65 cm]{figures/iconFaculty\f.pdf}%
		\hspace*{0.5 cm}%
	}%
}

% Use the faculty name as default institution
\institute{\insertfacultyname}

% CD page 16
\makeatletter
	% Fallback if faculty=hs is specified: reset to empty
	\ifthenelse{\equal{\default@faculty}{hs}}{\def\default@faculty{}}{}
	
	\begin{switch}{\default@faculty}  
		\case{inw}{
			\addto\captionsngerman{\renewcommand{\insertfacultyname}{Ingenieur\-wissenschaften}}
			\addto\captionsenglish{\renewcommand{\insertfacultyname}{Engineering Sciences}}
			\gdef\insertfacultyicon{\includegraphics[height=0.65 cm]{figures/iconFacultyINW.pdf}}
		}  
		\case{cb}{
			\addto\captionsngerman{\renewcommand{\insertfacultyname}{Angewandte Computer- und Biowissenschaften}}
			\addto\captionsenglish{\renewcommand{\insertfacultyname}{Applied Computer Sciences and Biosciences}}
			\gdef\insertfacultyicon{\includegraphics[height=0.65 cm]{figures/iconFacultyCB.pdf}}
		}  
		\case{wi}{
			\addto\captionsngerman{\renewcommand{\insertfacultyname}{Wirtschafts\-ingenieurwesen}}
			\addto\captionsenglish{\renewcommand{\insertfacultyname}{Industrial Engineering}}
			\gdef\insertfacultyicon{\includegraphics[height=0.65 cm]{figures/iconFacultyWI.pdf}}
		}  
		\case{sw}{
			\addto\captionsngerman{\renewcommand{\insertfacultyname}{Soziale Arbeit}}
			\addto\captionsenglish{\renewcommand{\insertfacultyname}{Social Sciences}}
			\gdef\insertfacultyicon{\includegraphics[height=0.65 cm]{figures/iconFacultySW.pdf}}
		}  
		\case{me}{
			\addto\captionsngerman{\renewcommand{\insertfacultyname}{Medien}}
			\addto\captionsenglish{\renewcommand{\insertfacultyname}{Media Sciences}}
			\gdef\insertfacultyicon{\includegraphics[height=0.65 cm]{figures/iconFacultyME.pdf}}
		}
		\default{% Default: placing all icons without any text 
			\gdef\default@faculty{} % resetting faculty to hs, if anything else is given, to correctly load color theme
		}
	\end{switch}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Define speaker commands

\newcommand{\currentspeakerlabel}{}
\addto\captionsngerman{\renewcommand{\currentspeakerlabel}{Sprecher}}
\addto\captionsenglish{\renewcommand{\currentspeakerlabel}{Speaker}}

\NewDocumentCommand{\setcurrentspeaker}{sm}{\gdef\currentSpeaker{\IfBooleanTF#1{\currentspeakerlabel{}: }{}#2}}
\NewDocumentCommand{\resetcurrentspeaker}{s}{\IfBooleanTF#1{\setcurrentspeaker*{\insertauthor}}{\setcurrentspeaker{\insertauthor}}}
\NewDocumentCommand{\insertcurrentspeaker}{}{\currentSpeaker}

\resetcurrentspeaker{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Load theme files

\makeatletter
	\usecolortheme{hsmw\default@faculty} % Load specific color theme for faculty
	\usecolortheme{hsmw} % Load default color theme (previously defined values will be used)
	\usefonttheme{hsmw} % Used fonts and font styles
	\useinnertheme{hsmw} % Typesetting objects inside the frames (content): enumerations, blocks, toc, ...
	\useoutertheme{hsmw} % Typesetting the overall layout, headline, footer, sidebar, logo, navigation, frametitle, ...
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Prepare macros for easier access of default slides

% Redefines the maketitle macro
\RenewDocumentCommand{\maketitle}{}
{
	\begin{frame}[plain]
		\titlepage
	\end{frame}
}
% Automatically inserts maketitle at the beginning of the document
\AddToHook{begindocument}{\maketitle}

%  Defines the maketoc macro
\NewDocumentCommand{\maketoc}{}
{
	\begin{frame}{\contentsname}
		\tableofcontents
	\end{frame}
}

%  Defines the makebibliography macro
\NewDocumentCommand{\makebibliography}{}
{
	\begin{frame}[allowframebreaks]{\bibname}
		\printbibliography
	\end{frame}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Defines the makethankyou macro and associated macros for content modification

\NewDocumentCommand{\makethankyou}{}
{
	\begin{frame}[plain]
		\usebeamertemplate*{thankyou page}
	\end{frame}
}
\newcommand{\insertthankyoutitle}{}
\addto\captionsngerman{\renewcommand{\insertthankyoutitle}{Vielen Dank}}
\addto\captionsenglish{\renewcommand{\insertthankyoutitle}{Thank You}}

\NewDocumentCommand{\insertthankyousidebartext}{}
{
	\textbf{Hochschule Mittweida}
	\newline
	University of Applied Sciences
	\newline
	Technikumplatz 17 | 09648 Mittweida
	\if&\insertfacultyname&\else
		\newline
		\insertfacultyname
	\fi
}
\newcommand{\insertemail}{}
\newcommand{\inserttelephone}{}
\newcommand{\insertlocation}{}
\newcommand{\impressum}[3]
{
	\renewcommand{\inserttelephone}{#1}	
	\renewcommand{\insertemail}{#2}	
	\renewcommand{\insertlocation}{#3}	
}
\newcommand{\insertthankyoutext}
{
	\iftoggle{use@fancystyle}
	{	
		\begin{tabularx}{\linewidth}{@{}cX@{}}
			\faIdCard[regular] & \insertauthor\\
			\\
			\if\relax\insertemail\relax\else
				\faEnvelope[regular] & \insertemail\\
			\fi
			\if\relax\inserttelephone\relax\else
				\faPhone* & \inserttelephone\\
			\fi
			\if\relax\insertlocation\relax\else
				\\
				\faUniversity & \insertlocation\\
			\fi
		\end{tabularx}
	}{
		\insertauthor
		
		\vspace*{\baselineskip}
		\if\relax\inserttelephone\relax\else
			\textbf{T}\qquad\inserttelephone
		\fi
		
		\if\relax\insertemail\relax\else
			\insertemail
		\fi
	
		\if\relax\insertlocation\relax\else
		\vspace*{\baselineskip}
		\insertlocation
		\fi
	}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Patches and adjustments

% Redefine top aligned frames to remove additional skip for nicer overall alignments of contents: https://github.com/josephwright/beamer/blob/main/base/beamerbaseframe.sty#L262
\makeatletter
\define@key{beamerframe}{t}[true]{% top
	\beamer@frametopskip=0pt\relax% \beamer@frametopskip=.2cm plus .5\paperheight\relax%
	\beamer@framebottomskip=0pt plus 1fill\relax%
	\beamer@frametopskipautobreak=\beamer@frametopskip\relax%
	\beamer@framebottomskipautobreak=\beamer@framebottomskip\relax%
}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Place 2 slightly shrinked slides per a4 page on handout mode
\mode<handout>
{
	\usepackage{pgfpages}
	\pgfpagesuselayout{2 on 1}[a4paper, border shrink=5mm]
}
