\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{beamerthemehsmw}[2022/05/11 Beamer Vorlage der Hochschule Mittweida] % https://zip.hs-mittweida.de/intranet/corporate_design.php
% Please note: This template currently addresses primarily pdflatex (no active development with lualatex or xelatex, although compatibility is watched out for)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Process theme options

% Allows options as key-value pairs (\DeclareOptionX instead of \DeclareOption)
\RequirePackage{xkeyval} 

\makeatletter
	% Sets the default faculty to hs (responsible for color model, institute name and institute icon)
	\def\option@value@faculty{}
	\DeclareOptionX{hs}{\def\option@value@faculty{}}			% <empty>, hs (default)
	\DeclareOptionX{inw}{\def\option@value@faculty{inw}}		% inw (maybe incorporate alternative/old values: mb)
	\DeclareOptionX{cb}{\def\option@value@faculty{cb}}			% cb (maybe incorporate alternative/old values: mni)
	\DeclareOptionX{wi}{\def\option@value@faculty{wi}}			% wi (maybe incorporate alternative/old values: ww)
	\DeclareOptionX{sw}{\def\option@value@faculty{sw}}			% sw (maybe incorporate alternative/old values: sa)
	\DeclareOptionX{me}{\def\option@value@faculty{me}}			% me
	\DeclareOptionX{inst}{\def\option@value@faculty{inst}}		% inst
	\DeclareOptionX{faculty}[]{\def\option@value@faculty{#1}}

	% Declare language as key value option (default: ngerman)
	\DeclareOptionX{language}[ngerman]{\PassOptionsToPackage{#1}{babel}} % Passes language directly to babel 

	% Insert a table of contents at the beginning of the document (default: off)
	\DeclareOptionX{toc}{\AddToHook{begindocument/end}{\maketoc}}

	% Insert a separate frame for each section heading (ignore \section*) (default: off)
	\DeclareOptionX{sectionslide}{\AtBeginSection[]{\begin{frame}<beamer>[plain]\sectionpage\end{frame}}}

	% Hides the total number of slide in footline (default: on)
	\newtoggle{option@totalpages}\toggletrue{option@totalpages}
	\DeclareOptionX{nototalpages}{\togglefalse{option@totalpages}}
	
	% Hides the faculty icon on title page (default: on)
	\newtoggle{option@facultyicon}\toggletrue{option@facultyicon}
	\DeclareOptionX{nofacultyicon}{\togglefalse{option@facultyicon}}

	% Enables coloring of math text | possible values: off (default if not specified), full, nottext (default if specified)
	\def\option@value@colormath{off}
	\DeclareOptionX{colormath}[nottext]{\def\option@value@colormath{#1}}

	% Enables Two that the handout is twosided needs handout option in beamerclass to make a difference
	\newtoggle{option@printhandout}
	\DeclareOptionX{printhandout}{\toggletrue{option@printhandout}}

	%%%%%%% Non-compliant options %%%%%%%

	% Shows the date on the titelpage
	\newtoggle{option@titlepagedate}
	\DeclareOptionX{titlepagedate}{\toggletrue{option@titlepagedate}}

	% Enables some fancy styles, that are not part of the corporate design specifications (default: off)
	\newtoggle{option@fancystyle}
	\DeclareOptionX{fancystyle}{\toggletrue{option@fancystyle}}

	% Shows the progressbar in footline (default: on)
	\newtoggle{option@progressbar}  % \settoggle{show@progressbar}{true|false} \toggletrue{show@progressbar} % \iftoggle{show@progressbar}{if}{else}
	\DeclareOptionX{progressbar}{\toggletrue{option@progressbar}}

	%%%%%%% Option processing %%%%%%%
	
	% Print warnings for unknown options
	\DeclareOptionX*{\PackageWarning{bemaerthemehsmw}{Unknown option is ignored: \CurrentOption}}
	
	% Default options to be loaded 
	\ExecuteOptionsX{language=ngerman}
	
	% Process all options
	\ProcessOptionsX\relax
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Load Packages
% Preloaded packages by beamer in presentation mode: amsthm, color, enumerate, hyperref, xcolor

% Pass specific options to the font package depending on the used compiler (pdfLaTeX, XeLaTeX, LuaLaTeX)
\RequirePackage{iftex}
\iftutex% True for XeTeX (\ifxetex) and LuaTeX (ifluatex)
    \PassOptionsToPackage{defaultsans}{opensans}%make opensans default sans font
\else% Probably PDFTeX
    \RequirePackage[T1]{fontenc} % Font-Encoding
    \RequirePackage[utf8]{inputenc} % Input-Encoding
\fi

\RequirePackage{lmodern} % Font tweaking to latin modern (less pixelated) as fallback font
\RequirePackage[default,proportional]{opensans} % Use OpenSans as default font with proportional numbers

\RequirePackage{babel} % Load babel package for language support (options passed by theme option "language")
\RequirePackage{hyphenat} % Disables hyphenation by using a fake language (provides \nohyphens{})
\RequirePackage[autostyle]{csquotes} % Improves nested quoting (provides \enquote makro for language specific quoting)
\RequirePackage[fixed]{fontawesome5} % Provides modern symbols (http://mirrors.ctan.org/fonts/fontawesome5/doc/fontawesome5.pdf)
%\RequirePackage[factor=1100, stretch=10, shrink=10, babel=true, nopatch=footnote]{microtype} %TODO: Seems to have problems within overleaf: "keyval error: nopatch undefined"

\RequirePackage{tikz} % Tikz-Library for improved drawing capabilities
\RequirePackage{tikz-layers} % Loads background library and creates new layers to use as scope options "backround", "behind", "main" (normal), "above", "glass" (e.g. "on above layer")

\RequirePackage{tabularx, booktabs} % Tabular packages

\RequirePackage{etoolbox} % Programming library
\RequirePackage[absolute, overlay]{textpos} % Absolute placement of elements (display with option showboxes)
\RequirePackage{adjustbox} % Versatile box environments (e.g. resizebox)
\RequirePackage{caption} % Customizing options of captions (provides \captionof{env}{text})

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Default configurations

% Sets the page grid to the default aspect ratio for easy alignment: (1, 1) is 1 cm away from the right and top border; (8, 4.5) is the page center
\TPGrid{16}{9} 

% Sets the distance between figure/table and caption
\captionsetup{skip=.25cm}

% Adds the subtitle into the pdf document metadata
\AddToHook{begindocument/before}{\subject{\insertsubtitle}}
% Sets the pdf keywords
\keywords{Hochschule Mittweida}

% TODO If more than one institute is given, they should be separated using the command \and and they should be prefixed by the command \inst with different parameters.
% \author{Name\inst{1} \and Name\inst{1,2} \and Name\inst{3}}
% \institute{\inst{1} First Institute \and \inst{2} Second Department \and \inst{3} Third University}  

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Latex switch case construct

%TODO: Replace by more robust version that is capable of global changes (ifthenelse works in local group) and use more stable toggle from etoolbox instead of boolean
\RequirePackage{ifthen} % provide Makros \newboolean, \setboolean, \ifthenelse ect. 
\newboolean{default}
\newcommand{\case}{}
\newcommand{\default}{}
\newenvironment{switch}[1]%
{%
	\setboolean{default}{true}%
	\renewcommand{\case}[2]{\ifthenelse{\equal{#1}{##1}}{\setboolean{default}{false}##2}{}}%
	\renewcommand{\default}[1]{\ifthenelse{\boolean{default}}{##1}{}}%
}{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Set faculty name and icon

% The name of the faculty (default: empty)
\newcommand{\insertfacultyname}{} 
% The faculty logo (default: all icons side by side)
\newcommand{\insertfacultyicon}
{%
	\foreach \f in {INW, CB, WI, SW, ME, HS}%
	{%
		\includegraphics[height=0.65 cm]{figures/iconFaculty\f.pdf}%
		\hspace*{0.5 cm}%
	}%
}

% CD page 16
\makeatletter
	% Fallback if faculty=hs is specified: reset to empty
	\ifthenelse{\equal{\option@value@faculty}{hs}}{\def\option@value@faculty{}}{}
	
	\begin{switch}{\option@value@faculty}  
		\case{inw}{
			\addto\captionsngerman{\renewcommand{\insertfacultyname}{Ingenieur\-wissenschaften}}
			\addto\captionsenglish{\renewcommand{\insertfacultyname}{Engineering Sciences}}
			\gdef\insertfacultyicon{\includegraphics[height=0.65 cm]{figures/iconFacultyINW.pdf}}
		}  
		\case{cb}{
			\addto\captionsngerman{\renewcommand{\insertfacultyname}{Angewandte Computer- und Biowissenschaften}}
			\addto\captionsenglish{\renewcommand{\insertfacultyname}{Applied Computer Sciences and Biosciences}}
			\gdef\insertfacultyicon{\includegraphics[height=0.65 cm]{figures/iconFacultyCB.pdf}}
		}  
		\case{wi}{
			\addto\captionsngerman{\renewcommand{\insertfacultyname}{Wirtschafts\-ingenieurwesen}}
			\addto\captionsenglish{\renewcommand{\insertfacultyname}{Industrial Engineering}}
			\gdef\insertfacultyicon{\includegraphics[height=0.65 cm]{figures/iconFacultyWI.pdf}}
		}  
		\case{sw}{
			\addto\captionsngerman{\renewcommand{\insertfacultyname}{Soziale Arbeit}}
			\addto\captionsenglish{\renewcommand{\insertfacultyname}{Social Sciences}}
			\gdef\insertfacultyicon{\includegraphics[height=0.65 cm]{figures/iconFacultySW.pdf}}
		}  
		\case{me}{
			\addto\captionsngerman{\renewcommand{\insertfacultyname}{Medien}}
			\addto\captionsenglish{\renewcommand{\insertfacultyname}{Media Sciences}}
			\gdef\insertfacultyicon{\includegraphics[height=0.65 cm]{figures/iconFacultyME.pdf}}
		}
		\case{inst}{
			\gdef\insertfacultyicon{\includegraphics[height=0.65 cm]{figures/iconFacultyHS.pdf}}
			\gdef\option@value@faculty{} % Load default blue hsmw color theme
		}
		\default{% Default: placing all icons without any text 
			\gdef\option@value@faculty{} % resetting faculty to hs, if anything else is given, to correctly load color theme
		}
	\end{switch}
\makeatother
%TODO: Introduce separate options for color theme, faculty icon, faculty name (titlepage and footnote) and use presets for currently existing setups (hs, cb, ...)

% Use the faculty name as default institution
\institute{\insertfacultyname}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Define speaker commands

\newcommand{\currentspeakerlabel}{}
\addto\captionsngerman{\renewcommand{\currentspeakerlabel}{Sprecher}}
\addto\captionsenglish{\renewcommand{\currentspeakerlabel}{Speaker}}

\NewDocumentCommand{\setcurrentspeaker}{sm}{\gdef\currentSpeaker{\IfBooleanTF#1{\currentspeakerlabel{}: }{}#2}}
\NewDocumentCommand{\resetcurrentspeaker}{s}{\IfBooleanTF#1{\setcurrentspeaker*{\insertshortauthor}}{\setcurrentspeaker{\insertshortauthor}}}
\NewDocumentCommand{\insertcurrentspeaker}{}{\currentSpeaker}

\resetcurrentspeaker{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Load theme files

\makeatletter
	\usecolortheme{hsmw\option@value@faculty} % Load specific color theme for faculty
	\usecolortheme{hsmw} % Load default color theme (previously defined values will be used)
	\usefonttheme{hsmw} % Used fonts and font styles
	\useinnertheme{hsmw} % Typesetting objects inside the frames (content): enumerations, blocks, toc, ...
	\useoutertheme{hsmw} % Typesetting the overall layout, headline, footer, sidebar, logo, navigation, frametitle, ...
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Prepare macros for easier access of default slides

% Redefines the maketitle macro
\RenewDocumentCommand{\maketitle}{}
{
	\begin{frame}[plain]
		\titlepage
	\end{frame}
}
% Automatically inserts maketitle at the beginning of the document
\AddToHook{begindocument}{\maketitle}

%  Defines the maketoc macro
\NewDocumentCommand{\maketoc}{}
{
	\begin{frame}{\contentsname}
		\tableofcontents
	\end{frame}
}

%  Defines the makebibliography macro
\NewDocumentCommand{\makebibliography}{}
{
	\begin{frame}[allowframebreaks]{\bibname}
		\printbibliography
	\end{frame}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Defines the makethankyou macro and associated macros for content modification

\NewDocumentCommand{\makethankyou}{}
{
	\begin{frame}[plain]
		\usebeamertemplate*{thankyou page}
	\end{frame}
}
\newcommand{\insertthankyoutitle}{}
\addto\captionsngerman{\renewcommand{\insertthankyoutitle}{Vielen Dank}}
\addto\captionsenglish{\renewcommand{\insertthankyoutitle}{Thank You}}

\NewDocumentCommand{\insertthankyousidebartext}{}
{
	\textbf{Hochschule Mittweida}
	\newline
	University of Applied Sciences
	\newline
	Technikumplatz 17 | 09648 Mittweida
	\if&\insertshortinstitute&\else
		\newline
		\insertshortinstitute
	\fi
}
\newcommand{\insertemail}{}
\newcommand{\inserttelephone}{}
\newcommand{\insertlocation}{}
\newcommand{\impressum}[3]
{
	\renewcommand{\inserttelephone}{#1}	
	\renewcommand{\insertemail}{#2}	
	\renewcommand{\insertlocation}{#3}	
}
\newcommand{\insertthankyoutext}
{
	\iftoggle{option@fancystyle}
	{	
		\begin{tabularx}{\linewidth}{@{}cX@{}}
			\faIdCard[regular] & \insertauthor\\
			\\
			\if&\insertemail&\else % TODO: Check with \relax causes \href to crash
				\faEnvelope[regular] & \insertemail\\
			\fi
			\if\relax\inserttelephone\relax\else
				\faPhone* & \inserttelephone\\
			\fi
			\if\relax\insertlocation\relax\else
				\\
				\faUniversity & \insertlocation\\
			\fi
		\end{tabularx}
	}{
		\insertauthor
		
		\vspace*{\baselineskip}
		\if\relax\inserttelephone\relax\else
			\textbf{T}\qquad\inserttelephone
		\fi
		
		\if&\insertemail&\else % TODO: Check with \relax causes \href to crash
			\insertemail
		\fi
	
		\if\relax\insertlocation\relax\else
			\vspace*{\baselineskip}
			\insertlocation
		\fi
	}% this comment fixes underfull hbox in fancystyle
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Patches and adjustments

\makeatletter
	% Redefine top aligned frames to remove additional skip for nicer overall alignments of contents: https://github.com/josephwright/beamer/blob/main/base/beamerbaseframe.sty#L262
	\define@key{beamerframe}{t}[true]%
	{% top
		\beamer@frametopskip=0pt\relax% \beamer@frametopskip=.2cm plus .5\paperheight\relax%
		\beamer@framebottomskip=0pt plus 1fill\relax%
		\beamer@frametopskipautobreak=\beamer@frametopskip\relax%
		\beamer@framebottomskipautobreak=\beamer@framebottomskip\relax%
	}

	% Redefine shortinserts, so they are not stuck in a box (break all preparations): https://github.com/josephwright/beamer/blob/main/base/beamerbasemisc.sty#L186
	\renewcommand{\beamer@insertshort}[1]%
	{%\beamer@ststart#1\beamer@stend
		#1%
	}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\mode<handout>
{
	% Place 2 slightly shrinked slides per a4 page on handout mode
	\iftoggle{option@printhandout}
	{
		%TODO: Maybe find a workaround to automatically pass the classoption handout to already loaded beamer

		\usepackage{pgfpages}
		\pgfpagesuselayout{2 on 1}[a4paper, border shrink=5mm]
	}
}{}%
