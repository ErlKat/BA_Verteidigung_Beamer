%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Inner theme should be responsible for
%- Title and part pages.
%- Itemize environments.
%- Enumerate environments.
%- Description environments.
%- Block environments.
%- Theorem and proof environments.
%- Figures and tables.
%- Footnotes.
%- Bibliography entries.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Set some default styles

\setbeamercovered{dynamic} % items to uncover are no longer invisible, but now transparent (options: invisible, transparent=50, dynamic, highly dynamic, still covered, again covered)

\setbeamertemplate{caption}[default] % Add figure and table numbers (options: default (only text), numbered (text+number), caption name own line (only text, on extra line))

%\setbeamertemplate{itemize items}[circle]
\setbeamertemplate{itemize item}[circle] % (options: default (triangle), triangle, circle, square, ball)
\setbeamertemplate{itemize subitem}[triangle]
\setbeamertemplate{itemize subsubitem}[square]

%\setbeamertemplate{enumerate items}[circle]
\setbeamertemplate{enumerate item}[circle] % (options: default (text), circle, square, ball)
\setbeamertemplate{enumerate subitem}[square]
\setbeamertemplate{enumerate subsubitem}[circle]

% Reclaims the first indentation on itemize and enumerate
\setlength{\leftmargini}{0.5cm}
\setlength{\leftmarginii}{0.5cm}
\setlength{\leftmarginiii}{0.5cm}

\makeatletter
	% Patch underline-Command to smash its contents and destroy the bounding box, thus drawing a nice baseline-underline
	\let\old@underline\underline
	\renewcommand{\underline}[1]{\old@underline{\smash{#1}}}
\makeatother

%TODO Debug Background
%\setbeamertemplate{background}[grid]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newsavebox{\facultyIconBox}
\savebox{\facultyIconBox}{\insertfacultyicon}

% Title page
\defbeamertemplate*{title page}{hsmw}
{
	\def\spacer{.15 cm}

	% Faculty logo and text
	\begin{textblock}{9.25}(1, 0.675)
		\begin{beamercolorbox}[wd=\linewidth, ht=0.65 cm, dp=0cm, leftskip = 0cm]{title page faculty}
			\iftoggle{show@facultyicon}
			{%
				\usebox{\facultyIconBox}%
				\hspace*{\spacer}%
				\pgfmathparse{\linewidth - \wd\facultyIconBox - \spacer}%
			}
			{\pgfmathparse{\linewidth}}%
			%
			\ifstrempty{\insertinstitute}{}
			{%
				\vbox to 0.65cm{\hsize=\pgfmathresult pt%
					\usebeamerfont{title page faculty}%
					\vfill%
					\vspace*{.5ex}%
					\insertinstitute%
					\vphantom{Ag}% Align Baseline
					\vfill%
				}%	
			}%
		\end{beamercolorbox}	
	\end{textblock}
	
	\ifx\inserttitlegraphic\empty
		\def\boxWidth{14}
		\def\boxStart{3}
		\def\boxHeight{2.5}
	\else
		\def\boxWidth{6.75}
		\def\boxStart{2.2}
		\def\boxHeight{3.2}
	\fi
	
	% Title
	\begin{textblock}{\boxWidth}(1, \boxStart)
		\begin{beamercolorbox}[wd=\linewidth, ht=\boxHeight cm, dp=0cm, leftskip = 0cm]{title page title} 
			\usebeamerfont{title page title}%
			\autofontscaledownbox{\linewidth}{\boxHeight cm}{\inserttitle}
		\end{beamercolorbox}	
	\end{textblock}
	
	% Subtitle
	\begin{textblock}{\boxWidth}(1, 5.75)
		\begin{beamercolorbox}[wd=\linewidth, ht=1 cm, dp=.0cm, leftskip = 0cm]{title page subtitle} 
			\vbox to 1cm{\hsize=\linewidth
				\usebeamerfont{title page subtitle}%
				\autofontscaledownbox{\linewidth}{1 cm}{\insertsubtitle}%
				\vfill
			}
		\end{beamercolorbox}	
	\end{textblock}

	% Author
	\begin{textblock}{6.75}(1, 6.8)
		\begin{beamercolorbox}[wd=\linewidth, ht=1 cm, dp=0cm, leftskip = 0cm]{title page subsubtitle} 
			\usebeamerfont{title page subsubtitle}%
			\insertauthor
		\end{beamercolorbox}	
	\end{textblock}

	% Date
	\begin{textblock}{6.75}(1, 8.2)
		\begin{beamercolorbox}[wd=\linewidth, ht=.5 cm, dp=0cm, leftskip = 0cm]{title page date} 
			\vbox to .5cm{
				\usebeamerfont{title page date}%
				\insertdate
				\vfill
			}
		\end{beamercolorbox}	
	\end{textblock}

	% Background
	\begin{tikzpicture}[remember picture, overlay]
		\usebeamercolor{title page image}
		\begin{scope}[on background layer]
			% Gray Background
			\fill[color=bg] (current page.north west) ++(0, -1.8) rectangle ++(16, -6.2);
			
			% Optional Background image
			\ifx\inserttitlegraphic\empty
			\else
				\fill[color=bg] (current page.north west) ++(8, -1.8) node[anchor=north west, inner sep=0] {\includegraphics[height=6.2cm]{\inserttitlegraphic}};
			\fi
		\end{scope}
	\end{tikzpicture}

	% Sidebar
	\usebeamercolor{title page sidebar}
	\usebeamertemplate*{sidebar}
}

% Section page
\defbeamertemplate*{section page}{hsmw}
{
	\begin{textblock}{16}(0, 0) % 10.67
		\begin{beamercolorbox}[wd=\linewidth, ht=9cm]{section page} 
			%Background only
		\end{beamercolorbox}	
	\end{textblock}

	\begin{textblock}{14}(1, 1)	% 9.67
		\begin{beamercolorbox}[wd=\linewidth, ht=3cm]{section page title} 
			\usebeamerfont{section page title}%
			\insertsection
		\end{beamercolorbox}	
	\end{textblock}
	
	\begin{textblock}{2}(.5, 4.25)
		\begin{beamercolorbox}[wd=\linewidth, ht=.05cm]{section page rule} 
			%rule only
		\end{beamercolorbox}	
	\end{textblock}

%	\tableofcontents[currentsection]
}

% Thank you page
\defbeamertemplate*{thankyou page}{hsmw}
{
	\begin{textblock}{8.5}(1, 2.5)
		\begin{beamercolorbox}[wd=\linewidth, ht=1 cm]{thankyou page title}
			\vbox to 1cm{%
				\usebeamerfont{thankyou page title}%
				\insertthankyoutitle%
				\vfill
			}
		\end{beamercolorbox}	
	\end{textblock}

	\begin{textblock}{8.5}(1, 4)
		\begin{beamercolorbox}[wd=\linewidth, ht=4 cm]{thankyou page text}
			\vbox to 4cm{%
				\usebeamerfont{thankyou page text}%
				\insertthankyoutext
				\vfill
			}
		\end{beamercolorbox}	
	\end{textblock}

	\begin{textblock}{5}(10.5, 4)
		\begin{beamercolorbox}[wd=\linewidth, ht=2.5 cm]{thankyou page sidebar text}
			\vbox to 2.5cm{%
				\usebeamerfont{thankyou page sidebar text}%
				\insertthankyousidebartext
				\vfill
			}
		\end{beamercolorbox}	
	\end{textblock}

	\begin{tikzpicture}[remember picture, overlay] %TODO: externalize and combine with title page
		\begin{scope}[on background layer]
			\node (bg) at (current page.center) {\includegraphics[width=\paperwidth]{figures/thankyou.jpg}};
			\fill[hsmw, fill opacity=.8] (bg.north west) rectangle (bg.south east);
		\end{scope}
	\end{tikzpicture}

	\usebeamercolor{thankyou page sidebar}
	\usebeamertemplate*{sidebar}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Adjust font size to better fit text into box if it gets too large
\makeatletter
	\newlength{\autofontscaledownbox@maxHeight}
	\newlength{\autofontscaledownbox@boxHeight}
	\newsavebox{\autofontscaledown@box}
	
	\NewDocumentCommand{\autofontscaledownbox}{mmm} % width, height, text
	{%
		\setlength{\autofontscaledownbox@maxHeight}{#2}%
		%
		\foreach \f in {1, 0.99, ..., 0.1}%
		{%
			\pgfmathsetmacro{\scaledFontsize}{\f * \f@size}% \f@size = current font size
			\pgfmathsetmacro{\scaledBaselineskip}{\scaledFontsize * 1.2}%
			%
			\savebox{\autofontscaledown@box}{\parbox[b]{#1}{\nohyphenation\raggedright\fontsize{\scaledFontsize pt}{\scaledBaselineskip pt}\selectfont#3\par}}%
			\setlength{\autofontscaledownbox@boxHeight}{\ht\autofontscaledown@box}%
			%
			\ifnum\autofontscaledownbox@boxHeight<\autofontscaledownbox@maxHeight%
				\usebox{\autofontscaledown@box}%
				\if1\f\else{\PackageWarning{beamerinnerthemehsmw}{Font of text '#3' is scaled down by a factor of \f}}\fi%
				\breakforeach%
			\fi%
		}%
	}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%TODO: Check footnote hacks of old template

%\renewcommand{\thefootnote}{\fnsymbol{footnote}}
%\setbeamerfont{footnote}{size=\tiny}
%\setbeamerfont{footnote mark}{size=\tiny}
%\renewcommand{\footnoterule}{\textcolor{gray!75}{\rule{1.5cm}{.3pt}\\[.5ex]}}
%\renewcommand\@makefntext[1]{\noindent\makebox[0.35em][r]{\usebeamerfont{footnote}\color{gray!75}${}^{\mbox{\@thefnmark}}\hspace{-0.05em}$}\usebeamerfont{footnote}\textcolor{gray!75}{#1}}
%\let\footnoteold\footnote
%\renewcommand\footnote[2][]{
%	\ifthenelse{\value{footnote}=0}
%	{\footnoteold[#1]{\vspace{2.5mm}#2}}
%	{\PackageWarningNoLine{beamerthemeMittweida.sty}{Nur eine Fussnote pro Seite erlaubt, zweite Fussnote wird ignoriert}}
%}
%\@addtoreset{footnote}{page}
